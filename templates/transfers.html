{% extends 'layout.html' %}

{% block title %}Transfers{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/transfers.css') }}">
<script defer src="{{ url_for('static', filename='js/transfers.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üí∏ Transfers</h1>
        <p>Filter by season and fee, then sort by date or amount.</p>
    </div>

    <form class="filter-bar" method="get" action="{{ url_for('transfers_page') }}">
        <input type="hidden" name="submitted" value="1">
        <div class="filter-group">
            <label for="season">Season</label>
            <select id="season" name="season">
                <option value="">Select season</option>
                {% for s in seasons %}
                    <option value="{{ s }}" {% if filters.season == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="from_league">From League</label>
            <select id="from_league" name="from_league">
                <option value="">Any league</option>
                {% for league in leagues %}
                <option value="{{ league.value }}" {% if filters.from_league == league.value %}selected{% endif %}>
                    {{ league.country }} ‚Äî {{ league.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="to_league">To League</label>
            <select id="to_league" name="to_league">
                <option value="">Any league</option>
                {% for league in leagues %}
                <option value="{{ league.value }}" {% if filters.to_league == league.value %}selected{% endif %}>
                    {{ league.country }} ‚Äî {{ league.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="min_fee">Min Fee (‚Ç¨)</label>
            <input id="min_fee" name="min_fee" inputmode="numeric" value="{{ filters.min_fee }}">
        </div>
        <div class="filter-group">
            <label for="max_fee">Max Fee (‚Ç¨)</label>
            <input id="max_fee" name="max_fee" inputmode="numeric" value="{{ filters.max_fee }}">
        </div>
        <div class="filter-group">
            <label for="sort">Sort</label>
            <select id="sort" name="sort">
                <option value="" {% if not filters.sort %}selected{% endif %}>Date (Newest ‚Üí Oldest)</option>
                <option value="date_asc" {% if filters.sort == 'date_asc' %}selected{% endif %}>Date (Oldest ‚Üí Newest)</option>
                <option value="fee_desc" {% if filters.sort == 'fee_desc' %}selected{% endif %}>Fee (High ‚Üí Low)</option>
                <option value="fee_asc" {% if filters.sort == 'fee_asc' %}selected{% endif %}>Fee (Low ‚Üí High)</option>
                <option value="value_desc" {% if filters.sort == 'value_desc' %}selected{% endif %}>Value (High ‚Üí Low)</option>
                <option value="value_asc" {% if filters.sort == 'value_asc' %}selected{% endif %}>Value (Low ‚Üí High)</option>
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="filter-button">Apply Filters</button>
            <a class="reset-link" href="{{ url_for('transfers_page') }}">Clear</a>
        </div>
    </form>

    {% if filter_applied %}
        {% if transfers %}
        <div class="players-table-wrapper transfers-table-wrapper">
            <div class="transfers-list">
                <div class="transfers-header transfers-row">
                    <div class="transfer-cell player-col">Player</div>
                    <div class="transfer-cell position-col">Position</div>
                    <div class="transfer-cell age-col">Age</div>
                    <div class="transfer-cell nat-col">Nationality</div>
                    <div class="transfer-cell clubs-col">Clubs</div>
                    <div class="transfer-cell value-col">Value</div>
                    <div class="transfer-cell fee-col">Fee</div>
                    <div class="transfer-cell date-col">Date</div>
                </div>
                <div class="transfers-body">
                    {% for transfer in transfers %}
                    <div class="transfers-row fade-in">
                        <div class="transfer-cell player-col">
                            <div class="transfer-player">
                                <div class="player-mini-avatar">
                                    {{ transfer.player_name[0]|upper if transfer.player_name else 'üí∏' }}
                                </div>
                                <div class="player-meta">
                                    {% set player_name = transfer.player_name or 'Unknown Player' %}
                                    {% if transfer.player_name %}
                                    <a class="player-name player-name-link" href="{{ url_for('players_page', search=transfer.player_name) }}">
                                        {{ player_name }}
                                    </a>
                                    {% else %}
                                    <div class="player-name">{{ player_name }}</div>
                                    {% endif %}
                                    <div class="player-sub">{{ transfer.sub_position or '‚Äî' }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="transfer-cell position-col text-center">{{ transfer.sub_position or '‚Äî' }}</div>
                        <div class="transfer-cell age-col text-center">{{ transfer.age or '‚Äî' }}</div>
                        <div class="transfer-cell nat-col text-center">{{ transfer.country_of_citizenship or '‚Äî' }}</div>
                        <div class="transfer-cell clubs-col">
                            <div class="club-stack">
                                <div class="club-cell">
                                    {% set from_club = transfer.from_club or 'N/A' %}
                                    {% if transfer.from_club %}
                                    <a class="club-name club-link" href="{{ url_for('clubs_page', search=transfer.from_club) }}">{{ from_club }}</a>
                                    {% else %}
                                    <div class="club-name">{{ from_club }}</div>
                                    {% endif %}
                                    <div class="club-sub">From</div>
                                </div>
                                <div class="club-cell">
                                    {% set to_club = transfer.to_club or 'N/A' %}
                                    {% if transfer.to_club %}
                                    <a class="club-name club-link" href="{{ url_for('clubs_page', search=transfer.to_club) }}">{{ to_club }}</a>
                                    {% else %}
                                    <div class="club-name">{{ to_club }}</div>
                                    {% endif %}
                                    <div class="club-sub">To</div>
                                </div>
                            </div>
                        </div>
                        <div class="transfer-cell value-col text-right">
                            {% if transfer.player_value is not none %}
                                {% set mv_str = "{:,.2f}".format(transfer.player_value) %}
                                {% set mv_tr = mv_str.replace(",", "X").replace(".", ",").replace("X", ".") %}
                                ‚Ç¨{{ mv_tr }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                        <div class="transfer-cell fee-col text-right">
                            {% if transfer.transfer_fee_value is not none %}
                                {% set fee_str = "{:,.2f}".format(transfer.transfer_fee_value) %}
                                {% set fee_tr = fee_str.replace(",", "X").replace(".", ",").replace("X", ".") %}
                                ‚Ç¨{{ fee_tr }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                        <div class="transfer-cell date-col text-center">
                            {% if transfer.transfer_date %}
                                {{ transfer.transfer_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% if total_pages > 1 %}
        <div class="pagination-container">
            <div class="pagination">
                {% if page > 1 %}
                <a href="{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, from_league=filters.from_league, to_league=filters.to_league, page=page-1) }}" class="page-link arrow">‚Üê</a>
                {% endif %}

                {% set start_page = page - 2 %}
                {% set end_page = page + 2 %}

                {% if start_page < 1 %}
                    {% set start_page = 1 %}
                    {% set end_page = 5 %}
                {% endif %}

                {% if end_page > total_pages %}
                    {% set end_page = total_pages %}
                    {% set start_page = total_pages - 4 %}
                    {% if start_page < 1 %}{% set start_page = 1 %}{% endif %}
                {% endif %}

                {% if start_page > 1 %}
                    <a href="{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, from_league=filters.from_league, to_league=filters.to_league, page=1) }}" class="page-link">1</a>
                    {% if start_page > 2 %}
                        <span class="dots">...</span>
                    {% endif %}
                {% endif %}

                {% for p in range(start_page, end_page + 1) %}
                    <a href="{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, from_league=filters.from_league, to_league=filters.to_league, page=p) }}" class="page-link {% if p == page %}active{% endif %}">
                        {{ p }}
                    </a>
                {% endfor %}

                {% if end_page < total_pages %}
                    {% if end_page < total_pages - 1 %}
                        <span class="dots">...</span>
                    {% endif %}
                    <a href="{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, from_league=filters.from_league, to_league=filters.to_league, page=total_pages) }}" class="page-link">{{ total_pages }}</a>
                {% endif %}

                {% if page < total_pages %}
                <a href="{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, from_league=filters.from_league, to_league=filters.to_league, page=page+1) }}" class="page-link arrow">‚Üí</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="no-results">
            <p>No transfers match these filters.</p>
        </div>
        {% endif %}
    {% else %}
        <div class="helper-box">
            Fill the filters and hit <strong>Apply Filters</strong> to list transfers.
        </div>
    {% endif %}
</div>
{% endblock %}
