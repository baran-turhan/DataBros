{% extends 'layout.html' %}

{% block title %}Transfers{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/transfers.css') }}">
<script defer src="{{ url_for('static', filename='js/transfers.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>ğŸ’¸ Transfers</h1>
        <p>Filter by season and fee, then sort by date or amount.</p>
    </div>

    <form class="filter-bar" method="get" action="{{ url_for('transfers_page') }}">
        <input type="hidden" name="submitted" value="1">
        <div class="filter-group">
            <label for="season">Season</label>
            <select id="season" name="season">
                <option value="">Select season</option>
                {% for s in seasons %}
                    <option value="{{ s }}" {% if filters.season == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="min_fee">Min Fee (â‚¬)</label>
            <input id="min_fee" name="min_fee" inputmode="numeric" value="{{ filters.min_fee }}">
        </div>
        <div class="filter-group">
            <label for="max_fee">Max Fee (â‚¬)</label>
            <input id="max_fee" name="max_fee" inputmode="numeric" value="{{ filters.max_fee }}">
        </div>
        <div class="filter-group">
            <label for="sort">Sort</label>
            <select id="sort" name="sort">
                <option value="" {% if not filters.sort %}selected{% endif %}>Date (Newest â†’ Oldest)</option>
                <option value="date_asc" {% if filters.sort == 'date_asc' %}selected{% endif %}>Date (Oldest â†’ Newest)</option>
                <option value="fee_desc" {% if filters.sort == 'fee_desc' %}selected{% endif %}>Fee (High â†’ Low)</option>
                <option value="fee_asc" {% if filters.sort == 'fee_asc' %}selected{% endif %}>Fee (Low â†’ High)</option>
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="filter-button">Apply Filters</button>
            <a class="reset-link" href="{{ url_for('transfers_page') }}">Clear</a>
        </div>
    </form>

    {% if filter_applied %}
        {% if transfers %}
        <div class="table-wrapper">
            <table class="transfer-table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Position</th>
                        <th>Age</th>
                        <th>Nationality</th>
                        <th>Clubs</th>
                        <th>Value</th>
                        <th>Fee</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transfer in transfers %}
                    <tr>
                        <td class="player-cell">
                            <div class="player-avatar">
                                {{ transfer.player_name[0]|upper if transfer.player_name else 'ğŸ’¸' }}
                            </div>
                            <div class="player-meta">
                                <div class="player-name">{{ transfer.player_name or 'Unknown Player' }}</div>
                            </div>
                        </td>
                        <td class="text-center">{{ transfer.sub_position or 'â€”' }}</td>
                        <td class="text-center">{{ transfer.age or 'â€”' }}</td>
                        <td class="text-center">{{ transfer.country_of_citizenship or 'â€”' }}</td>
                        <td class="club-stack">
                            <div class="club-cell">
                                <div class="club-name">{{ transfer.from_club or 'N/A' }}</div>
                                <div class="club-sub">From</div>
                            </div>
                            <div class="club-cell">
                                <div class="club-name">{{ transfer.to_club or 'N/A' }}</div>
                                <div class="club-sub">To</div>
                            </div>
                        </td>
                        <td class="text-right">
                            {% if transfer.player_value is not none %}
                                {% set mv_str = "{:,.2f}".format(transfer.player_value) %}
                                {% set mv_tr = mv_str.replace(",", "X").replace(".", ",").replace("X", ".") %}
                                â‚¬{{ mv_tr }}
                            {% else %}
                                â€”
                            {% endif %}
                        </td>
                        <td class="text-right">
                            {% if transfer.transfer_fee_value is not none %}
                                {% set fee_str = "{:,.2f}".format(transfer.transfer_fee_value) %}
                                {% set fee_tr = fee_str.replace(",", "X").replace(".", ",").replace("X", ".") %}
                                â‚¬{{ fee_tr }}
                            {% else %}
                                â€”
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if transfer.transfer_date %}
                                {{ transfer.transfer_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                â€”
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="pagination">
            <div class="page-info">
                {{ total_results }} transfers total Â· Page {{ page }} / {{ total_pages if total_pages else 1 }} Â· {{ per_page }} per page
            </div>
            <div class="page-actions">
                {% set prev_page = page - 1 %}
                {% set next_page = page + 1 %}
                <a
                    class="page-button {% if page <= 1 %}disabled{% endif %}"
                    href="{% if page > 1 %}{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, page=prev_page) }}{% else %}#{% endif %}">
                    â† Previous
                </a>
                <a
                    class="page-button {% if total_pages and page >= total_pages %}disabled{% endif %}"
                    href="{% if total_pages and page < total_pages %}{{ url_for('transfers_page', submitted=1, season=filters.season, min_fee=filters.min_fee, max_fee=filters.max_fee, sort=filters.sort, page=next_page) }}{% else %}#{% endif %}">
                    Next â†’
                </a>
            </div>
        </div>
        {% else %}
        <div class="no-results">
            <p>No transfers match these filters.</p>
        </div>
        {% endif %}
    {% else %}
        <div class="helper-box">
            Fill the filters and hit <strong>Apply Filters</strong> to list transfers.
        </div>
    {% endif %}
</div>
{% endblock %}
